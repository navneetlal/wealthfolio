{
  "openapi": "3.0.3",
  "info": {
    "version": "1.0.0",
    "title": "Wealthfolio Connect API",
    "description": "Wealthfolio Cloud REST API for brokerage data synchronization.\n\n## Authentication\nAll endpoints require Bearer token authentication. Include the JWT token in the Authorization header:\n```\nAuthorization: Bearer <your-jwt-token>\n```\n\n## Base URL\n- Production: `https://api.wealthfolio.app/api/v1`\n- Staging: `https://api-staging.wealthfolio.app/api/v1`\n\n## Optional Headers\nThe following headers can be sent with requests for localization and debugging:\n\n| Header | Type | Description |\n|--------|------|-------------|\n| `X-User-Locale` | string | User's locale (e.g., `en-US`, `fr-CA`) |\n| `X-User-Timezone` | string | User's timezone (e.g., `America/New_York`) |\n| `X-User-Country` | string | User's country code (e.g., `US`, `CA`) |\n| `X-WF-Device-Id` | UUID | Device ID for device-specific sync operations |\n\n## Rate Limiting\nAPI requests are rate limited. If you exceed the limit, you'll receive a 429 response.\n\n## Error Responses\nAll error responses follow the same format:\n```json\n{\n  \"error\": \"ERROR_CODE\",\n  \"code\": \"ERROR_CODE\",\n  \"message\": \"Human-readable error description\"\n}\n```\n",
    "contact": {
      "name": "Wealthfolio Support",
      "email": "support@wealthfolio.app",
      "url": "https://wealthfolio.app"
    }
  },
  "servers": [
    { "url": "https://api.wealthfolio.app", "description": "Production API" },
    { "url": "https://api-staging.wealthfolio.app", "description": "Staging API" },
    { "url": "http://localhost:8787", "description": "Local development" }
  ],
  "tags": [
    {
      "name": "Sync Brokerage",
      "description": "Endpoints for syncing brokerage data including connections, accounts, holdings, and activities/transactions."
    },
    {
      "name": "Sync Devices",
      "description": "Device registration and management for E2EE device sync."
    },
    { "name": "Sync Keys", "description": "Key management for end-to-end encryption." },
    { "name": "Sync Team", "description": "Team synchronization operations." },
    {
      "name": "Sync Events",
      "description": "Event-based sync endpoints for pushing and pulling encrypted sync events between devices."
    },
    { "name": "User", "description": "User profile and preferences." },
    { "name": "Subscription", "description": "Subscription and billing operations." }
  ],
  "security": [{ "bearer": [] }],
  "components": {
    "securitySchemes": {
      "bearer": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT Bearer token authentication. Obtain token from Supabase Auth."
      }
    },
    "schemas": {},
    "parameters": {}
  },
  "paths": {
    "/api/v1/user/me": {
      "get": {
        "operationId": "getCurrentUser",
        "tags": ["User"],
        "summary": "Get current user",
        "description": "Get the authenticated user's profile with team info and pending invitation (if user has no team)",
        "security": [{ "bearer": [] }],
        "responses": {
          "200": {
            "description": "User profile",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "nullable": true,
                  "properties": {
                    "id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Unique identifier of the user",
                      "example": "019234ab-cdef-7890-abcd-ef1234567890"
                    },
                    "fullName": {
                      "type": "string",
                      "nullable": true,
                      "description": "Full name of the user",
                      "example": "Jane Doe"
                    },
                    "email": {
                      "type": "string",
                      "nullable": true,
                      "description": "Email address of the user",
                      "example": "jane.doe@acme.com"
                    },
                    "avatarUrl": {
                      "type": "string",
                      "nullable": true,
                      "description": "URL to the user's avatar image",
                      "example": "https://cdn.wealthfolio.app/avatars/jane-doe.jpg"
                    },
                    "locale": {
                      "type": "string",
                      "nullable": true,
                      "description": "User's preferred locale for internationalization",
                      "example": "en-US"
                    },
                    "timeFormat": {
                      "type": "number",
                      "nullable": true,
                      "description": "User's preferred time format: 12 or 24",
                      "example": 24
                    },
                    "dateFormat": {
                      "type": "string",
                      "nullable": true,
                      "description": "User's preferred date format",
                      "example": "yyyy-MM-dd"
                    },
                    "weekStartsOnMonday": {
                      "type": "boolean",
                      "nullable": true,
                      "description": "Whether the user's calendar week starts on Monday",
                      "example": true
                    },
                    "timezone": {
                      "type": "string",
                      "nullable": true,
                      "description": "User's timezone identifier (IANA format)",
                      "example": "America/New_York"
                    },
                    "timezoneAutoSync": {
                      "type": "boolean",
                      "nullable": true,
                      "description": "Whether to automatically sync timezone with browser",
                      "example": true
                    },
                    "teamId": {
                      "type": "string",
                      "nullable": true,
                      "format": "uuid",
                      "description": "ID of the team the user belongs to",
                      "example": "019234ab-cdef-7890-abcd-ef1234567890"
                    },
                    "teamRole": {
                      "type": "string",
                      "nullable": true,
                      "description": "User's role in their team (owner or member)",
                      "example": "owner"
                    },
                    "team": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Unique identifier of the team",
                          "example": "019234ab-cdef-7890-abcd-ef1234567890"
                        },
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "description": "Name of the team or organization",
                          "example": "Acme Corporation"
                        },
                        "logoUrl": {
                          "type": "string",
                          "nullable": true,
                          "description": "URL to the team's logo image",
                          "example": "https://cdn.wealthfolio.app/logos/acme-corp.png"
                        },
                        "plan": {
                          "type": "string",
                          "nullable": true,
                          "description": "Current subscription plan of the team (null if no active subscription)",
                          "example": "essentials"
                        },
                        "billingEmail": {
                          "type": "string",
                          "nullable": true,
                          "description": "Email address for billing communications",
                          "example": "billing@acme.com"
                        },
                        "subscriptionStatus": {
                          "type": "string",
                          "nullable": true,
                          "description": "Current subscription status from Stripe",
                          "example": "active"
                        },
                        "stripeCustomerId": {
                          "type": "string",
                          "nullable": true,
                          "description": "Stripe customer ID",
                          "example": "cus_abc123"
                        },
                        "stripeSubscriptionId": {
                          "type": "string",
                          "nullable": true,
                          "description": "Stripe subscription ID",
                          "example": "sub_abc123"
                        },
                        "stripePriceId": {
                          "type": "string",
                          "nullable": true,
                          "description": "Stripe price ID for current plan",
                          "example": "price_abc123"
                        },
                        "subscriptionCurrentPeriodEnd": {
                          "type": "string",
                          "nullable": true,
                          "description": "End date of current billing period (ISO 8601)",
                          "example": "2025-02-01T00:00:00Z"
                        },
                        "subscriptionCancelAtPeriodEnd": {
                          "type": "boolean",
                          "nullable": true,
                          "description": "Whether subscription will cancel at period end",
                          "example": false
                        },
                        "createdAt": {
                          "type": "string",
                          "nullable": true,
                          "description": "Team creation timestamp (ISO 8601)",
                          "example": "2025-01-01T00:00:00Z"
                        },
                        "countryCode": {
                          "type": "string",
                          "nullable": true,
                          "description": "Two-letter country code",
                          "example": "US"
                        },
                        "canceledAt": {
                          "type": "string",
                          "nullable": true,
                          "description": "Subscription cancellation date (ISO 8601)",
                          "example": null
                        }
                      },
                      "required": [
                        "id",
                        "name",
                        "logoUrl",
                        "plan",
                        "billingEmail",
                        "subscriptionStatus",
                        "stripeCustomerId",
                        "stripeSubscriptionId",
                        "stripePriceId",
                        "subscriptionCurrentPeriodEnd",
                        "subscriptionCancelAtPeriodEnd",
                        "createdAt",
                        "countryCode",
                        "canceledAt"
                      ],
                      "description": "Team information including subscription details"
                    },
                    "pendingInvite": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Unique identifier of the invitation",
                          "example": "019234ab-cdef-7890-abcd-ef1234567890"
                        },
                        "email": {
                          "type": "string",
                          "nullable": true,
                          "description": "Email address the invitation was sent to",
                          "example": "jane.doe@acme.com"
                        },
                        "role": {
                          "type": "string",
                          "nullable": true,
                          "description": "Role the user will have in the team (owner or member)",
                          "example": "member"
                        },
                        "invitedBy": {
                          "type": "object",
                          "nullable": true,
                          "properties": {
                            "id": { "type": "string", "format": "uuid" },
                            "fullName": { "type": "string", "nullable": true },
                            "email": { "type": "string", "nullable": true }
                          },
                          "required": ["id", "fullName", "email"],
                          "description": "User who sent the invitation"
                        },
                        "team": {
                          "type": "object",
                          "nullable": true,
                          "properties": {
                            "id": { "type": "string", "format": "uuid" },
                            "name": { "type": "string", "nullable": true },
                            "logoUrl": { "type": "string", "nullable": true }
                          },
                          "required": ["id", "name", "logoUrl"],
                          "description": "Team that sent the invitation"
                        }
                      },
                      "required": ["id", "email", "role", "invitedBy", "team"],
                      "description": "Pending team invitation for the user (only present if user has no team)"
                    }
                  },
                  "required": [
                    "id",
                    "fullName",
                    "email",
                    "avatarUrl",
                    "locale",
                    "timeFormat",
                    "dateFormat",
                    "weekStartsOnMonday",
                    "timezone",
                    "timezoneAutoSync",
                    "teamId",
                    "teamRole",
                    "team",
                    "pendingInvite"
                  ],
                  "description": "User profile with team info and pending invitation"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/subscription/plans": {
      "get": {
        "operationId": "getSubscriptionPlans",
        "tags": ["Subscription"],
        "summary": "Get subscription plans",
        "description": "Get available subscription plans with pricing. Public endpoint, cached at edge.",
        "responses": {
          "200": {
            "description": "Subscription plans",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plans": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "enum": ["essentials", "duo", "plus"],
                            "description": "Plan identifier"
                          },
                          "name": {
                            "type": "string",
                            "description": "Display name",
                            "example": "Connect Duo"
                          },
                          "tagline": {
                            "type": "string",
                            "description": "Short tagline",
                            "example": "Two-person household"
                          },
                          "description": {
                            "type": "string",
                            "description": "Full description",
                            "example": "Built for couples: one combined view, shared by choice."
                          },
                          "pricing": {
                            "type": "object",
                            "properties": {
                              "monthly": {
                                "type": "number",
                                "description": "Monthly price in USD",
                                "example": 7.99
                              },
                              "yearly": {
                                "type": "number",
                                "description": "Yearly price in USD",
                                "example": 79
                              },
                              "yearlyPerMonth": {
                                "type": "number",
                                "description": "Effective monthly price when billed yearly",
                                "example": 6.58
                              }
                            },
                            "required": ["monthly", "yearly", "yearlyPerMonth"],
                            "description": "Plan pricing information"
                          },
                          "limits": {
                            "type": "object",
                            "properties": {
                              "householdSize": {
                                "type": "integer",
                                "description": "Maximum household members",
                                "example": 2
                              },
                              "institutionConnections": {
                                "anyOf": [
                                  { "type": "integer" },
                                  { "type": "string", "enum": ["unlimited"] }
                                ],
                                "description": "Maximum institution connections or 'unlimited'",
                                "example": 12
                              },
                              "devices": {
                                "type": "integer",
                                "description": "Maximum synced devices",
                                "example": 8
                              }
                            },
                            "required": ["householdSize", "institutionConnections", "devices"],
                            "description": "Plan resource limits"
                          },
                          "features": {
                            "type": "array",
                            "items": { "type": "string" },
                            "description": "Short feature list for cards",
                            "example": ["Household: 2 people"]
                          },
                          "featuresExtended": {
                            "type": "array",
                            "items": { "type": "string" },
                            "description": "Extended feature list for details"
                          },
                          "isAvailable": {
                            "type": "boolean",
                            "description": "Whether plan can be purchased",
                            "example": true
                          },
                          "isComingSoon": {
                            "type": "boolean",
                            "description": "Whether plan is coming soon",
                            "example": false
                          },
                          "badge": {
                            "type": "string",
                            "description": "Optional badge text",
                            "example": "Popular"
                          },
                          "yearlyDiscountPercent": {
                            "type": "integer",
                            "description": "Percentage saved with yearly billing",
                            "example": 18
                          }
                        },
                        "required": [
                          "id",
                          "name",
                          "tagline",
                          "description",
                          "pricing",
                          "limits",
                          "features",
                          "featuresExtended",
                          "isAvailable",
                          "isComingSoon",
                          "yearlyDiscountPercent"
                        ],
                        "description": "Subscription plan"
                      },
                      "description": "Available subscription plans"
                    }
                  },
                  "required": ["plans"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/keys/initialize": {
      "post": {
        "operationId": "initializeTeamKeys",
        "tags": ["Sync Keys"],
        "summary": "Initialize team keys",
        "description": "Phase 1: Returns next step for key initialization.\n\nReturns discriminated response:\n- **BOOTSTRAP**: Ready to initialize - challenge/nonce returned for key generation\n- **PAIRING_REQUIRED**: Already initialized - device must pair with trusted device\n- **READY**: Device already trusted at current key version",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "device_id": {
                    "type": "string",
                    "format": "uuid",
                    "description": "Device ID from enrollment. Must match X-WF-Device-Id header.",
                    "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                  }
                },
                "required": ["device_id"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Next step for key initialization",
            "content": {
              "application/json": {
                "schema": {
                  "anyOf": [
                    {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "enum": ["BOOTSTRAP"],
                          "description": "Ready to bootstrap - generate RK locally and call /commit"
                        },
                        "challenge": {
                          "type": "string",
                          "description": "Server-generated challenge to sign with RK (base64 encoded)",
                          "example": "YTFiMmMzZDQtZTVmNi03ODkwLWFiY2QtZWYxMjM0NTY3ODkw"
                        },
                        "nonce": {
                          "type": "string",
                          "description": "Nonce for replay protection (base64 encoded)",
                          "example": "ZjllOGQ3YzYtYjVhNC0zMjEwLWZlZGMtYmEwOTg3NjU0MzIx"
                        },
                        "key_version": {
                          "type": "integer",
                          "description": "Key version to use for initialization",
                          "example": 1
                        }
                      },
                      "required": ["mode", "challenge", "nonce", "key_version"]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "enum": ["PAIRING_REQUIRED"],
                          "description": "E2EE already initialized - device must pair with a trusted device"
                        },
                        "e2ee_key_version": {
                          "type": "integer",
                          "description": "Current E2EE key version (epoch)"
                        },
                        "require_sas": {
                          "type": "boolean",
                          "description": "Whether SAS verification is required during pairing"
                        },
                        "pairing_ttl_seconds": {
                          "type": "integer",
                          "description": "Time-to-live for pairing sessions in seconds"
                        },
                        "trusted_devices": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "id": {
                                "type": "string",
                                "format": "uuid",
                                "description": "Device ID"
                              },
                              "name": { "type": "string", "description": "Device display name" },
                              "platform": { "type": "string", "description": "Device platform" },
                              "last_seen_at": {
                                "type": "string",
                                "nullable": true,
                                "format": "date-time",
                                "description": "Last activity timestamp"
                              }
                            },
                            "required": ["id", "name", "platform", "last_seen_at"]
                          },
                          "description": "List of trusted devices that can approve pairing"
                        }
                      },
                      "required": [
                        "mode",
                        "e2ee_key_version",
                        "require_sas",
                        "pairing_ttl_seconds",
                        "trusted_devices"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "enum": ["READY"],
                          "description": "Device is already trusted at current key version"
                        },
                        "e2ee_key_version": {
                          "type": "integer",
                          "description": "Current E2EE key version (epoch)"
                        }
                      },
                      "required": ["mode", "e2ee_key_version"]
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - not eligible to initialize",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/keys/initialize/commit": {
      "post": {
        "operationId": "commitInitializeTeamKeys",
        "tags": ["Sync Keys"],
        "summary": "Commit key initialization",
        "description": "Phase 2: Upload signed proof and key envelopes to activate keys",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "device_id": {
                    "type": "string",
                    "format": "uuid",
                    "description": "Device ID from enrollment. Must match X-WF-Device-Id header.",
                    "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                  },
                  "key_version": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Key version to initialize (must match the version from initialize response)",
                    "example": 1
                  },
                  "device_key_envelope": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Device-specific key envelope encrypted with device's public key (base64 encoded)",
                    "example": "ZGV2aWNlX2tleV9lbnZlbG9wZQ=="
                  },
                  "signature": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Signature over the challenge proving possession of RK (base64 encoded)",
                    "example": "c2lnbmF0dXJlX2Jhc2U2NA=="
                  },
                  "challenge_response": {
                    "type": "string",
                    "description": "Response to the server challenge (base64 encoded)",
                    "example": "Y2hhbGxlbmdlX3Jlc3BvbnNl"
                  },
                  "recovery_envelope": {
                    "type": "string",
                    "description": "Optional recovery key envelope for account recovery (base64 encoded)",
                    "example": "cmVjb3ZlcnlfZW52ZWxvcGU="
                  }
                },
                "required": ["device_id", "key_version", "device_key_envelope", "signature"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Keys activated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    },
                    "key_state": {
                      "type": "string",
                      "enum": ["ACTIVE", "PENDING"],
                      "description": "Key state after initialization: ACTIVE (ready to use) or PENDING (awaiting additional steps)"
                    }
                  },
                  "required": ["success", "key_state"]
                }
              }
            }
          },
          "400": {
            "description": "Invalid signature or challenge response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/keys/rotate": {
      "post": {
        "operationId": "rotateTeamKeys",
        "tags": ["Sync Keys"],
        "summary": "Start key rotation",
        "description": "Phase 1: Start key rotation and return challenge/nonce",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "initiator_device_id": {
                    "type": "string",
                    "format": "uuid",
                    "description": "Device ID initiating the rotation. Must be a trusted device.",
                    "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                  }
                },
                "required": ["initiator_device_id"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Challenge for key rotation",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "challenge": {
                      "type": "string",
                      "description": "Server-generated challenge to sign (base64 encoded)",
                      "example": "YTFiMmMzZDQtZTVmNi03ODkwLWFiY2QtZWYxMjM0NTY3ODkw"
                    },
                    "nonce": {
                      "type": "string",
                      "description": "Nonce for replay protection (base64 encoded)",
                      "example": "ZjllOGQ3YzYtYjVhNC0zMjEwLWZlZGMtYmEwOTg3NjU0MzIx"
                    },
                    "new_key_version": {
                      "type": "integer",
                      "description": "Key version after rotation",
                      "example": 2
                    }
                  },
                  "required": ["challenge", "nonce", "new_key_version"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/keys/rotate/commit": {
      "post": {
        "operationId": "commitRotateTeamKeys",
        "tags": ["Sync Keys"],
        "summary": "Commit key rotation",
        "description": "Phase 2: Upload signed proof and new key envelopes",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "new_key_version": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "New key version after rotation",
                    "example": 2
                  },
                  "envelopes": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "device_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Target device ID"
                        },
                        "device_key_envelope": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Re-encrypted key envelope for this device (base64 encoded)"
                        }
                      },
                      "required": ["device_id", "device_key_envelope"]
                    },
                    "description": "Key envelopes for all trusted devices, re-encrypted with new keys"
                  },
                  "signature": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Signature over the rotation data (base64 encoded)",
                    "example": "c2lnbmF0dXJlX2Jhc2U2NA=="
                  },
                  "challenge_response": {
                    "type": "string",
                    "description": "Response to the server challenge (base64 encoded)",
                    "example": "Y2hhbGxlbmdlX3Jlc3BvbnNl"
                  }
                },
                "required": ["new_key_version", "envelopes", "signature"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Keys rotated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    },
                    "key_version": {
                      "type": "integer",
                      "description": "New key version after successful rotation",
                      "example": 2
                    }
                  },
                  "required": ["success", "key_version"]
                }
              }
            }
          },
          "400": {
            "description": "Invalid signature or challenge response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/keys/reset": {
      "post": {
        "operationId": "resetTeamKeys",
        "tags": ["Sync Keys"],
        "summary": "Reset team sync keys",
        "description": "**⚠️ DESTRUCTIVE** - Performs a team-wide reset of E2EE sync keys.\n\nThis operation:\n1. Increments the key version (epoch)\n2. Revokes trust from ALL devices\n3. The next device to enroll will receive BOOTSTRAP mode\n\nUse this when:\n- User lost access to all trusted devices\n- Suspected key compromise\n- Account recovery scenarios\n\n**Owner only** - Only the team owner can perform this action.",
        "security": [{ "bearer": [] }],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {
                    "type": "string",
                    "description": "Optional reason for the reset (stored in audit log)",
                    "example": "Lost access to all trusted devices"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Team sync reset successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    },
                    "key_version": {
                      "type": "integer",
                      "description": "New key version after reset (incremented from previous)",
                      "example": 2
                    },
                    "reset_at": {
                      "type": "string",
                      "nullable": true,
                      "format": "date-time",
                      "description": "Timestamp of the reset"
                    }
                  },
                  "required": ["success", "key_version", "reset_at"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - valid JWT required",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - only team owner can reset keys",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices": {
      "get": {
        "operationId": "listDevices",
        "tags": ["Sync Devices"],
        "summary": "List devices",
        "description": "List devices. Use scope=my for own devices, scope=team for all team devices (owner only)",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "enum": ["my", "team"],
              "default": "my",
              "description": "Scope of devices to list: 'my' for own devices (default), 'team' for all team devices (owner only)",
              "example": "my"
            },
            "required": false,
            "description": "Scope of devices to list: 'my' for own devices (default), 'team' for all team devices (owner only)",
            "name": "scope",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "List of devices",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": {
                        "type": "string",
                        "format": "uuid",
                        "description": "Unique device identifier"
                      },
                      "user_id": {
                        "type": "string",
                        "format": "uuid",
                        "description": "Owner user ID"
                      },
                      "display_name": {
                        "type": "string",
                        "description": "User-friendly device name",
                        "example": "Aziz's MacBook Pro"
                      },
                      "platform": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 32,
                        "description": "Device platform identifier",
                        "example": "mac"
                      },
                      "device_public_key": {
                        "type": "string",
                        "nullable": true,
                        "description": "Device's public key for E2EE (base64)"
                      },
                      "trust_state": {
                        "type": "string",
                        "enum": ["untrusted", "trusted", "revoked"],
                        "description": "Device trust state for E2EE sync"
                      },
                      "trusted_key_version": {
                        "type": "number",
                        "nullable": true,
                        "description": "E2EE key version the device is trusted at"
                      },
                      "os_version": {
                        "type": "string",
                        "nullable": true,
                        "description": "Operating system version",
                        "example": "macOS 14.0"
                      },
                      "app_version": {
                        "type": "string",
                        "nullable": true,
                        "description": "App version",
                        "example": "1.2.3"
                      },
                      "last_seen_at": {
                        "type": "string",
                        "nullable": true,
                        "format": "date-time",
                        "description": "Last activity timestamp"
                      },
                      "created_at": {
                        "type": "string",
                        "format": "date-time",
                        "description": "Registration timestamp"
                      }
                    },
                    "required": [
                      "id",
                      "user_id",
                      "display_name",
                      "platform",
                      "device_public_key",
                      "trust_state",
                      "trusted_key_version",
                      "os_version",
                      "app_version",
                      "last_seen_at",
                      "created_at"
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      },
      "post": {
        "operationId": "enrollDevice",
        "tags": ["Sync Devices"],
        "summary": "Enroll device for sync",
        "description": "Single entry point for device enrollment. Returns the next step for the device:\n\n- **BOOTSTRAP**: First device for this team - generate RK locally and call /sync/team/keys/initialize\n- **PAIR**: E2EE already enabled - device must pair with an existing trusted device\n- **READY**: Device is already trusted and ready to sync\n\nThis endpoint is idempotent - calling it multiple times with the same device_nonce returns the same device.",
        "security": [{ "bearer": [] }],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "device_nonce": {
                    "type": "string",
                    "format": "uuid",
                    "description": "Device nonce (UUID) stored in device Keychain for idempotent registration. This uniquely identifies a physical device and won't transfer with DB backup/restore.",
                    "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                  },
                  "display_name": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 64,
                    "description": "User-friendly name for the device",
                    "example": "Aziz's MacBook Pro"
                  },
                  "platform": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 32,
                    "description": "Platform type (ios, android, mac, windows, linux, web)",
                    "example": "mac"
                  },
                  "os_version": {
                    "type": "string",
                    "maxLength": 64,
                    "description": "Operating system version",
                    "example": "macOS 14.0"
                  },
                  "app_version": {
                    "type": "string",
                    "maxLength": 32,
                    "description": "App version",
                    "example": "1.2.3"
                  }
                },
                "required": ["device_nonce", "display_name", "platform"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Enrollment status and next step",
            "content": {
              "application/json": {
                "schema": {
                  "anyOf": [
                    {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "enum": ["BOOTSTRAP"],
                          "description": "First device - generate RK locally and initialize E2EE"
                        },
                        "device_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Server-assigned device ID"
                        },
                        "e2ee_key_version": {
                          "type": "integer",
                          "description": "E2EE key version (epoch) to use for initialization"
                        }
                      },
                      "required": ["mode", "device_id", "e2ee_key_version"]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "enum": ["PAIR"],
                          "description": "Device must pair with an existing trusted device to receive RK"
                        },
                        "device_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Server-assigned device ID"
                        },
                        "e2ee_key_version": {
                          "type": "integer",
                          "description": "Current E2EE key version (epoch)"
                        },
                        "require_sas": {
                          "type": "boolean",
                          "description": "Whether SAS verification is required during pairing"
                        },
                        "pairing_ttl_seconds": {
                          "type": "integer",
                          "description": "Time-to-live for pairing sessions in seconds"
                        },
                        "trusted_devices": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "id": { "type": "string", "format": "uuid" },
                              "name": { "type": "string" },
                              "platform": { "type": "string" },
                              "last_seen_at": {
                                "type": "string",
                                "nullable": true,
                                "format": "date-time"
                              }
                            },
                            "required": ["id", "name", "platform", "last_seen_at"]
                          },
                          "description": "List of trusted devices that can approve pairing"
                        }
                      },
                      "required": [
                        "mode",
                        "device_id",
                        "e2ee_key_version",
                        "require_sas",
                        "pairing_ttl_seconds",
                        "trusted_devices"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "enum": ["READY"],
                          "description": "Device is already trusted and ready to sync"
                        },
                        "device_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Server-assigned device ID"
                        },
                        "e2ee_key_version": {
                          "type": "integer",
                          "description": "Current E2EE key version (epoch)"
                        },
                        "trust_state": {
                          "type": "string",
                          "enum": ["untrusted", "trusted", "revoked"],
                          "description": "Current trust state of the device"
                        }
                      },
                      "required": ["mode", "device_id", "e2ee_key_version", "trust_state"]
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}": {
      "get": {
        "operationId": "getDevice",
        "tags": ["Sync Devices"],
        "summary": "Get device",
        "description": "Get a single device by ID",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Device details",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Unique device identifier"
                    },
                    "user_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Owner user ID"
                    },
                    "display_name": {
                      "type": "string",
                      "description": "User-friendly device name",
                      "example": "Aziz's MacBook Pro"
                    },
                    "platform": {
                      "type": "string",
                      "minLength": 1,
                      "maxLength": 32,
                      "description": "Device platform identifier",
                      "example": "mac"
                    },
                    "device_public_key": {
                      "type": "string",
                      "nullable": true,
                      "description": "Device's public key for E2EE (base64)"
                    },
                    "trust_state": {
                      "type": "string",
                      "enum": ["untrusted", "trusted", "revoked"],
                      "description": "Device trust state for E2EE sync"
                    },
                    "trusted_key_version": {
                      "type": "number",
                      "nullable": true,
                      "description": "E2EE key version the device is trusted at"
                    },
                    "os_version": {
                      "type": "string",
                      "nullable": true,
                      "description": "Operating system version",
                      "example": "macOS 14.0"
                    },
                    "app_version": {
                      "type": "string",
                      "nullable": true,
                      "description": "App version",
                      "example": "1.2.3"
                    },
                    "last_seen_at": {
                      "type": "string",
                      "nullable": true,
                      "format": "date-time",
                      "description": "Last activity timestamp"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Registration timestamp"
                    }
                  },
                  "required": [
                    "id",
                    "user_id",
                    "display_name",
                    "platform",
                    "device_public_key",
                    "trust_state",
                    "trusted_key_version",
                    "os_version",
                    "app_version",
                    "last_seen_at",
                    "created_at"
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Device not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      },
      "patch": {
        "operationId": "updateDevice",
        "tags": ["Sync Devices"],
        "summary": "Update device",
        "description": "Update device metadata (name, etc.)",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "display_name": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 64,
                    "description": "New display name for the device",
                    "example": "Work MacBook"
                  },
                  "metadata": {
                    "type": "object",
                    "additionalProperties": { "nullable": true },
                    "description": "Additional metadata to store with the device"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Device updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    }
                  },
                  "required": ["success"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Device not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      },
      "delete": {
        "operationId": "deleteDevice",
        "tags": ["Sync Devices"],
        "summary": "Delete device",
        "description": "Delete a device record",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Device deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    }
                  },
                  "required": ["success"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Device not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/revoke": {
      "post": {
        "operationId": "revokeDevice",
        "tags": ["Sync Devices"],
        "summary": "Revoke device",
        "description": "Revoke device trust",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Device revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    }
                  },
                  "required": ["success"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Device not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings": {
      "post": {
        "operationId": "createDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Create pairing session",
        "description": "Create a pairing session for a device (trusted device only)",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "code_hash": {
                    "type": "string",
                    "minLength": 64,
                    "maxLength": 64,
                    "description": "SHA-256 hash of the pairing code (hex encoded, 64 chars). The actual code is never sent to the server.",
                    "example": "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3"
                  },
                  "ephemeral_public_key": {
                    "type": "string",
                    "minLength": 1,
                    "description": "X25519 ephemeral public key for key exchange (base64 encoded)",
                    "example": "bGludXggaXMgYXdlc29tZQ=="
                  }
                },
                "required": ["code_hash", "ephemeral_public_key"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Pairing session created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "pairing_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Unique pairing session identifier"
                    },
                    "expires_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Session expiration timestamp"
                    },
                    "key_version": {
                      "type": "integer",
                      "description": "Current E2EE key version (epoch)"
                    },
                    "require_sas": {
                      "type": "boolean",
                      "description": "Whether SAS verification is required"
                    }
                  },
                  "required": ["pairing_id", "expires_at", "key_version", "require_sas"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/{pairingId}": {
      "get": {
        "operationId": "getDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Get pairing session",
        "description": "Get pairing session details",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "pairingId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Pairing session details",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "pairing_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Unique pairing session identifier"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["open", "claimed", "approved", "completed", "cancelled", "expired"],
                      "description": "Current session status: open → claimed → approved → completed (or cancelled/expired)"
                    },
                    "claimer_device_id": {
                      "type": "string",
                      "nullable": true,
                      "format": "uuid",
                      "description": "Device ID of the claimer (null if not yet claimed)"
                    },
                    "claimer_ephemeral_pub": {
                      "type": "string",
                      "nullable": true,
                      "description": "Claimer's ephemeral public key for deriving shared secret (base64, null if not claimed)"
                    },
                    "expires_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Session expiration timestamp"
                    }
                  },
                  "required": [
                    "pairing_id",
                    "status",
                    "claimer_device_id",
                    "claimer_ephemeral_pub",
                    "expires_at"
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Session not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/{pairingId}/approve": {
      "post": {
        "operationId": "approveDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Approve pairing",
        "description": "Approve a pairing session",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "pairingId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Pairing approved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    }
                  },
                  "required": ["success"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/{pairingId}/complete": {
      "post": {
        "operationId": "completeDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Complete pairing",
        "description": "Complete pairing with key bundle and SAS proof",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "pairingId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "encrypted_key_bundle": {
                    "type": "string",
                    "minLength": 1,
                    "description": "RK bundle encrypted with the shared secret derived from ephemeral keys (base64 encoded)",
                    "example": "ZW5jcnlwdGVkX3JrX2J1bmRsZQ=="
                  },
                  "sas_proof": {
                    "anyOf": [
                      { "type": "string" },
                      { "type": "object", "additionalProperties": { "nullable": true } }
                    ],
                    "description": "Proof of SAS verification (string or object depending on SAS method)"
                  },
                  "signature": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Signature over the encrypted bundle for authenticity (base64 encoded)",
                    "example": "c2lnbmF0dXJlX2Jhc2U2NA=="
                  }
                },
                "required": ["encrypted_key_bundle", "sas_proof", "signature"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Pairing completed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    }
                  },
                  "required": ["success"]
                }
              }
            }
          },
          "400": {
            "description": "Invalid proof or signature",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/{pairingId}/cancel": {
      "post": {
        "operationId": "cancelDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Cancel pairing",
        "description": "Cancel a pairing session",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "pairingId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Pairing cancelled",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "enum": [true],
                      "description": "Operation succeeded"
                    }
                  },
                  "required": ["success"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/claim": {
      "post": {
        "operationId": "claimDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Claim pairing session",
        "description": "Claim a pairing session using the code displayed on the issuer device. Returns issuer ephemeral public key for deriving shared secret.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "code": {
                    "type": "string",
                    "minLength": 6,
                    "maxLength": 16,
                    "description": "Pairing code displayed on the issuer device. This is hashed and compared server-side.",
                    "example": "ABCD-1234"
                  },
                  "ephemeral_public_key": {
                    "type": "string",
                    "minLength": 1,
                    "description": "X25519 ephemeral public key for key exchange (base64 encoded)",
                    "example": "bGludXggaXMgYXdlc29tZQ=="
                  }
                },
                "required": ["code", "ephemeral_public_key"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Session claimed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "session_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Pairing session ID (same as pairing_id)"
                    },
                    "issuer_ephemeral_pub": {
                      "type": "string",
                      "description": "Issuer's X25519 ephemeral public key for deriving shared secret (base64 encoded)",
                      "example": "bGludXggaXMgYXdlc29tZQ=="
                    },
                    "e2ee_key_version": {
                      "type": "integer",
                      "description": "Current E2EE key version (epoch)"
                    },
                    "require_sas": {
                      "type": "boolean",
                      "description": "Whether SAS verification is required"
                    },
                    "expires_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Session expiration timestamp"
                    }
                  },
                  "required": [
                    "session_id",
                    "issuer_ephemeral_pub",
                    "e2ee_key_version",
                    "require_sas",
                    "expires_at"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Invalid code or session expired",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/{pairingId}/messages": {
      "get": {
        "operationId": "getDevicePairingMessages",
        "tags": ["Sync Pairings"],
        "summary": "Poll pairing messages",
        "description": "Poll for encrypted messages in a pairing session. Used by claimer to receive RK bundle.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "pairingId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Messages in session",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "session_status": {
                      "type": "string",
                      "enum": ["open", "claimed", "approved", "completed", "canceled", "expired"],
                      "description": "Current session status"
                    },
                    "messages": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "Message identifier"
                          },
                          "payload_type": {
                            "type": "string",
                            "description": "Type of encrypted payload (e.g., 'rk_transfer_v1' for RK bundle)",
                            "example": "rk_transfer_v1"
                          },
                          "payload": {
                            "type": "string",
                            "description": "Encrypted payload (base64 encoded). Decrypt using shared secret derived from ephemeral keys."
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time",
                            "description": "Message timestamp"
                          }
                        },
                        "required": ["id", "payload_type", "payload", "created_at"]
                      },
                      "description": "List of encrypted messages in the pairing session"
                    }
                  },
                  "required": ["session_status", "messages"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - not the claimer",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Session not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/team/devices/{deviceId}/pairings/{pairingId}/confirm": {
      "post": {
        "operationId": "confirmDevicePairing",
        "tags": ["Sync Pairings"],
        "summary": "Confirm pairing and trust device",
        "description": "Confirm pairing after successfully decrypting the RK bundle from the pairing session.\nThis is the final step in the pairing flow - it marks the claimer device as trusted.\n\nThis endpoint is session-bound, ensuring trust is only granted through a valid pairing session.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "deviceId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "UUID identifier",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "UUID identifier",
            "name": "pairingId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "proof": {
                    "type": "string",
                    "description": "Optional HMAC proof that device successfully decrypted the RK bundle. Computed as HMAC(session_id, derived_key).",
                    "example": "YmFzZTY0X2htYWNfcHJvb2Y="
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Device marked as trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "enum": [true] },
                    "key_version": {
                      "type": "integer",
                      "description": "E2EE key version the device is now trusted at"
                    }
                  },
                  "required": ["success", "key_version"]
                }
              }
            }
          },
          "400": {
            "description": "Invalid proof",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - not the claimer or session not ready",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Session not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/events/push": {
      "post": {
        "operationId": "syncPushEvents",
        "tags": ["Sync Events"],
        "summary": "Push events to server",
        "description": "Push events from the client outbox to the server.\n\n**Validations:**\n- All events must have `device_id` matching the `X-WF-Device-Id` header\n- All events must have `payload_key_version` matching the current team E2EE key version\n- Max 500 events per batch\n- Each payload max 256KB (base64 encoded)\n\n**Idempotency:**\nEvents are deduplicated by `(user_id, event_id)`. Duplicate events are returned\nin the `duplicate` array with their existing sequence numbers.\n\n**Atomicity:**\nAll events in a batch are inserted atomically. If any event fails validation,\nthe entire batch is rejected.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "events": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "event_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Client-generated UUIDv7 event identifier for idempotency",
                          "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                        },
                        "device_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "Device ID that created this event (must match X-WF-Device-Id header)",
                          "example": "019b606a-e90b-76a3-94ef-f719b67faa91"
                        },
                        "type": {
                          "type": "string",
                          "description": "Event type in format: {entity}.{operation}.v{version}",
                          "example": "account.create.v1"
                        },
                        "entity": {
                          "type": "string",
                          "enum": [
                            "account",
                            "asset",
                            "asset_taxonomy_assignment",
                            "activity",
                            "activity_import_profile",
                            "goal",
                            "goals_allocation",
                            "ai_thread",
                            "ai_message",
                            "ai_thread_tag",
                            "contribution_limit",
                            "platform"
                          ],
                          "description": "Sync entity type",
                          "example": "account"
                        },
                        "entity_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "ID of the entity being modified",
                          "example": "019b606a-e90b-76a3-94ef-f719b67faa92"
                        },
                        "client_timestamp": {
                          "type": "string",
                          "format": "date-time",
                          "description": "Client wall-clock timestamp (ISO 8601)",
                          "example": "2025-01-01T12:00:00.000Z"
                        },
                        "payload": {
                          "type": "string",
                          "description": "Encrypted payload (base64 encoded). Max 256KB.",
                          "example": "ZW5jcnlwdGVkIGRhdGEgaGVyZQ=="
                        },
                        "payload_key_version": {
                          "type": "integer",
                          "minimum": 0,
                          "exclusiveMinimum": true,
                          "description": "E2EE key version used to encrypt the payload",
                          "example": 1
                        }
                      },
                      "required": [
                        "event_id",
                        "device_id",
                        "type",
                        "entity",
                        "entity_id",
                        "client_timestamp",
                        "payload",
                        "payload_key_version"
                      ]
                    },
                    "minItems": 1,
                    "maxItems": 500,
                    "description": "Array of events to push (max 500 per batch)"
                  }
                },
                "required": ["events"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Events pushed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "accepted": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "event_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "Event ID that was accepted",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                          },
                          "seq": {
                            "type": "integer",
                            "minimum": 0,
                            "exclusiveMinimum": true,
                            "description": "Server-assigned sequence number",
                            "example": 42
                          }
                        },
                        "required": ["event_id", "seq"]
                      },
                      "description": "Events that were newly inserted"
                    },
                    "duplicate": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "event_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "Event ID that was accepted",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                          },
                          "seq": {
                            "type": "integer",
                            "minimum": 0,
                            "exclusiveMinimum": true,
                            "description": "Server-assigned sequence number",
                            "example": 42
                          }
                        },
                        "required": ["event_id", "seq"]
                      },
                      "description": "Events that already existed (idempotent)"
                    },
                    "server_cursor": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Current max sequence number after push",
                      "example": 42
                    }
                  },
                  "required": ["accepted", "duplicate", "server_cursor"]
                }
              }
            }
          },
          "400": {
            "description": "Validation error (device mismatch, key version mismatch, etc.)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/events/pull": {
      "get": {
        "operationId": "syncPullEvents",
        "tags": ["Sync Events"],
        "summary": "Pull events from server",
        "description": "Pull events for replay on the client.\n\n**Visibility:**\nReturns events visible to the user:\n1. All events created by the user themselves\n2. Events from team members for shared entities (sharedWithHousehold=true)\n\n**Pagination:**\nUse `since` and `limit` for pagination. The `next_cursor` value should be\nused as `since` for the next request. Continue until `has_more` is false.\n\n**Ordering:**\nEvents are returned in ascending sequence order (oldest first).",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "integer",
              "nullable": true,
              "minimum": 0,
              "default": 0,
              "description": "Sequence number to start from (exclusive)",
              "example": 0
            },
            "required": false,
            "description": "Sequence number to start from (exclusive)",
            "name": "since",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 2000,
              "default": 500,
              "description": "Maximum number of events to return",
              "example": 500
            },
            "required": false,
            "description": "Maximum number of events to return",
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Events retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "from": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Starting sequence number (same as since)",
                      "example": 0
                    },
                    "to": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Ending sequence number (max seq in response)",
                      "example": 42
                    },
                    "next_cursor": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Cursor to use for next pull request",
                      "example": 42
                    },
                    "has_more": {
                      "type": "boolean",
                      "description": "Whether more events are available",
                      "example": false
                    },
                    "events": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "event_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "Client-generated UUIDv7 event identifier for idempotency",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
                          },
                          "device_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "Device ID that created this event (must match X-WF-Device-Id header)",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa91"
                          },
                          "type": {
                            "type": "string",
                            "description": "Event type in format: {entity}.{operation}.v{version}",
                            "example": "account.create.v1"
                          },
                          "entity": {
                            "type": "string",
                            "enum": [
                              "account",
                              "asset",
                              "asset_taxonomy_assignment",
                              "activity",
                              "activity_import_profile",
                              "goal",
                              "goals_allocation",
                              "ai_thread",
                              "ai_message",
                              "ai_thread_tag",
                              "contribution_limit",
                              "platform"
                            ],
                            "description": "Sync entity type",
                            "example": "account"
                          },
                          "entity_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "ID of the entity being modified",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa92"
                          },
                          "client_timestamp": {
                            "type": "string",
                            "format": "date-time",
                            "description": "Client wall-clock timestamp (ISO 8601)",
                            "example": "2025-01-01T12:00:00.000Z"
                          },
                          "payload": {
                            "type": "string",
                            "description": "Encrypted payload (base64 encoded). Max 256KB.",
                            "example": "ZW5jcnlwdGVkIGRhdGEgaGVyZQ=="
                          },
                          "payload_key_version": {
                            "type": "integer",
                            "minimum": 0,
                            "exclusiveMinimum": true,
                            "description": "E2EE key version used to encrypt the payload",
                            "example": 1
                          },
                          "seq": {
                            "type": "integer",
                            "minimum": 0,
                            "exclusiveMinimum": true,
                            "description": "Server-assigned sequence number (monotonic)",
                            "example": 42
                          },
                          "user_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "User ID that created the event",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa93"
                          },
                          "team_id": {
                            "type": "string",
                            "format": "uuid",
                            "description": "Team ID the event belongs to",
                            "example": "019b606a-e90b-76a3-94ef-f719b67faa94"
                          },
                          "server_timestamp": {
                            "type": "string",
                            "format": "date-time",
                            "description": "Server timestamp when event was recorded (ISO 8601)",
                            "example": "2025-01-01T12:00:01.000Z"
                          }
                        },
                        "required": [
                          "event_id",
                          "device_id",
                          "type",
                          "entity",
                          "entity_id",
                          "client_timestamp",
                          "payload",
                          "payload_key_version",
                          "seq",
                          "user_id",
                          "team_id",
                          "server_timestamp"
                        ]
                      },
                      "description": "Events in ascending sequence order"
                    },
                    "gc_watermark": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "GC watermark - minimum seq clients must have; if cursor < gc_watermark, bootstrap required",
                      "example": 500
                    },
                    "latest_snapshot_seq": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Sequence number of the latest snapshot event",
                      "example": 1500
                    }
                  },
                  "required": ["from", "to", "next_cursor", "has_more", "events"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/events/cursor": {
      "get": {
        "operationId": "syncGetCursor",
        "tags": ["Sync Events"],
        "summary": "Get current cursor",
        "description": "Get the current max visible sequence number (lightweight).\n\nUse this endpoint to check if there are new events without fetching them.\nCompare the returned cursor with your local cursor to determine if a pull is needed.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Current cursor value",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "cursor": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Current max visible sequence number",
                      "example": 42
                    },
                    "gc_watermark": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "GC watermark - minimum seq clients must have; if cursor < gc_watermark, bootstrap required",
                      "example": 500
                    },
                    "latest_snapshot": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "snapshot_id": {
                          "type": "string",
                          "format": "uuid",
                          "description": "ID of the latest snapshot",
                          "example": "019c1234-5678-7abc-def0-123456789abc"
                        },
                        "schema_version": {
                          "type": "integer",
                          "description": "Schema version of the snapshot",
                          "example": 1
                        },
                        "oplog_seq": {
                          "type": "integer",
                          "description": "Oplog sequence number of the snapshot",
                          "example": 1500
                        }
                      },
                      "required": ["snapshot_id", "schema_version", "oplog_seq"],
                      "description": "Metadata for the latest available snapshot"
                    }
                  },
                  "required": ["cursor"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/snapshots/upload": {
      "post": {
        "operationId": "syncUploadSnapshot",
        "tags": ["Sync Snapshots"],
        "summary": "Upload a snapshot to R2",
        "description": "Upload an encrypted snapshot blob to R2 storage.\n\n**Process:**\n1. Validates device is trusted\n2. Verifies checksum matches blob\n3. Checks size limits\n4. Uploads blob to R2\n5. Records snapshot.create.v1 event in oplog\n6. Returns snapshot metadata\n\n**Idempotency:**\nIf X-Snapshot-Event-Id header is provided and matches an existing event,\nreturns the existing snapshot without re-uploading.\n\n**Headers Required:**\n- X-WF-Device-Id: Device ID\n- X-Snapshot-Event-Id: (optional) Event ID for idempotency\n- X-Snapshot-Schema-Version: Schema version number\n- X-Snapshot-Covers-Tables: Comma-separated table list\n- X-Snapshot-Size-Bytes: Expected blob size\n- X-Snapshot-Checksum: SHA-256 checksum (sha256:hex)\n- X-Snapshot-Metadata-Payload: Encrypted metadata for oplog\n- X-Snapshot-Payload-Key-Version: E2EE key version",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID",
            "name": "x-wf-device-id",
            "in": "header"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Optional event ID for idempotent upload",
              "example": "019c9999-aaaa-bbbb-cccc-ddddeeeeffff"
            },
            "required": false,
            "description": "Optional event ID for idempotent upload",
            "name": "x-snapshot-event-id",
            "in": "header"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 0,
              "exclusiveMinimum": true,
              "description": "Schema version of the snapshot data",
              "example": 1
            },
            "required": true,
            "description": "Schema version of the snapshot data",
            "name": "x-snapshot-schema-version",
            "in": "header"
          },
          {
            "schema": {
              "type": "string",
              "description": "Comma-separated list of tables included in snapshot",
              "example": "accounts,activities,goals"
            },
            "required": true,
            "description": "Comma-separated list of tables included in snapshot",
            "name": "x-snapshot-covers-tables",
            "in": "header"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 0,
              "exclusiveMinimum": true,
              "description": "Size of the encrypted snapshot blob in bytes",
              "example": 234567
            },
            "required": true,
            "description": "Size of the encrypted snapshot blob in bytes",
            "name": "x-snapshot-size-bytes",
            "in": "header"
          },
          {
            "schema": {
              "type": "string",
              "description": "SHA-256 checksum of the encrypted blob (format: sha256:hex)",
              "example": "sha256:a1b2c3d4e5f6..."
            },
            "required": true,
            "description": "SHA-256 checksum of the encrypted blob (format: sha256:hex)",
            "name": "x-snapshot-checksum",
            "in": "header"
          },
          {
            "schema": {
              "type": "string",
              "description": "Base64-encoded encrypted snapshot metadata (for oplog event)",
              "example": "ZW5jcnlwdGVkIG1ldGFkYXRh..."
            },
            "required": true,
            "description": "Base64-encoded encrypted snapshot metadata (for oplog event)",
            "name": "x-snapshot-metadata-payload",
            "in": "header"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 0,
              "exclusiveMinimum": true,
              "description": "E2EE key version used to encrypt the metadata payload",
              "example": 1
            },
            "required": true,
            "description": "E2EE key version used to encrypt the metadata payload",
            "name": "x-snapshot-payload-key-version",
            "in": "header"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/octet-stream": { "schema": { "type": "string", "format": "binary" } }
          }
        },
        "responses": {
          "200": {
            "description": "Snapshot already exists (idempotent)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "snapshot_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Server-assigned snapshot ID",
                      "example": "019c1234-5678-7abc-def0-123456789abc"
                    },
                    "r2_key": {
                      "type": "string",
                      "description": "R2 object key where snapshot is stored",
                      "example": "snapshots/019b606a.../019c1234..."
                    },
                    "oplog_seq": {
                      "type": "integer",
                      "description": "Sequence number of the snapshot event in the oplog",
                      "example": 1500
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Timestamp when snapshot was created",
                      "example": "2026-01-19T12:00:00.000Z"
                    }
                  },
                  "required": ["snapshot_id", "r2_key", "oplog_seq", "created_at"]
                }
              }
            }
          },
          "201": {
            "description": "Snapshot uploaded successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "snapshot_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Server-assigned snapshot ID",
                      "example": "019c1234-5678-7abc-def0-123456789abc"
                    },
                    "r2_key": {
                      "type": "string",
                      "description": "R2 object key where snapshot is stored",
                      "example": "snapshots/019b606a.../019c1234..."
                    },
                    "oplog_seq": {
                      "type": "integer",
                      "description": "Sequence number of the snapshot event in the oplog",
                      "example": 1500
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Timestamp when snapshot was created",
                      "example": "2026-01-19T12:00:00.000Z"
                    }
                  },
                  "required": ["snapshot_id", "r2_key", "oplog_seq", "created_at"]
                }
              }
            }
          },
          "400": {
            "description": "Validation error (checksum mismatch, size limit, etc.)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/snapshots/{snapshotId}": {
      "get": {
        "operationId": "syncDownloadSnapshot",
        "tags": ["Sync Snapshots"],
        "summary": "Download a snapshot from R2",
        "description": "Download an encrypted snapshot blob from R2 storage.\n\nReturns the blob with metadata headers:\n- X-Snapshot-Schema-Version\n- X-Snapshot-Covers-Tables\n- X-Snapshot-Checksum",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Snapshot ID to download",
              "example": "019c1234-5678-7abc-def0-123456789abc"
            },
            "required": true,
            "description": "Snapshot ID to download",
            "name": "snapshotId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Snapshot blob. Response includes headers: X-Snapshot-Schema-Version, X-Snapshot-Covers-Tables, X-Snapshot-Checksum",
            "content": {
              "application/octet-stream": { "schema": { "type": "string", "format": "binary" } }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Snapshot not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/snapshots/latest": {
      "get": {
        "operationId": "syncGetLatestSnapshot",
        "tags": ["Sync Snapshots"],
        "summary": "Get latest snapshot metadata",
        "description": "Get metadata for the most recent available snapshot.\n\nUsed by clients during bootstrap to determine if a snapshot is available\nand compatible with their schema version.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "responses": {
          "200": {
            "description": "Latest snapshot metadata",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "snapshot_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "Snapshot ID",
                      "example": "019c1234-5678-7abc-def0-123456789abc"
                    },
                    "schema_version": {
                      "type": "integer",
                      "description": "Schema version of the snapshot",
                      "example": 1
                    },
                    "covers_tables": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "Tables included in snapshot",
                      "example": ["accounts", "activities", "goals"]
                    },
                    "oplog_seq": {
                      "type": "integer",
                      "description": "Oplog sequence number of the snapshot",
                      "example": 1500
                    },
                    "size_bytes": {
                      "type": "integer",
                      "description": "Size of encrypted blob in bytes",
                      "example": 234567
                    },
                    "checksum": {
                      "type": "string",
                      "description": "SHA-256 checksum",
                      "example": "sha256:a1b2c3d4e5f6..."
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Creation timestamp",
                      "example": "2026-01-19T12:00:00.000Z"
                    }
                  },
                  "required": [
                    "snapshot_id",
                    "schema_version",
                    "covers_tables",
                    "oplog_seq",
                    "size_bytes",
                    "checksum",
                    "created_at"
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "No snapshot available",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/snapshots/request": {
      "post": {
        "operationId": "syncRequestSnapshot",
        "tags": ["Sync Snapshots"],
        "summary": "Request snapshot generation",
        "description": "Request that a trusted device generate a snapshot.\n\nWrites a snapshot.request.v1 event to the oplog. Trusted devices\npolling for events will see this request and may generate a snapshot.\n\nUsed for on-demand bootstrap when no recent snapshot is available.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
              "example": "019b606a-e90b-76a3-94ef-f719b67faa90"
            },
            "required": true,
            "description": "Device ID obtained from device enrollment (POST /sync/team/devices). Required for all device-specific operations.",
            "name": "x-wf-device-id",
            "in": "header"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "min_schema_version": {
                    "type": "integer",
                    "minimum": 0,
                    "exclusiveMinimum": true,
                    "description": "Minimum schema version required",
                    "example": 1
                  },
                  "covers_tables": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "Tables that must be included",
                    "example": ["accounts", "activities"]
                  },
                  "payload": {
                    "type": "string",
                    "description": "Base64-encoded encrypted request metadata",
                    "example": "ZW5jcnlwdGVkIHJlcXVlc3Q="
                  },
                  "payload_key_version": {
                    "type": "integer",
                    "minimum": 0,
                    "exclusiveMinimum": true,
                    "description": "E2EE key version used to encrypt the payload",
                    "example": 1
                  }
                },
                "required": ["payload", "payload_key_version"]
              }
            }
          }
        },
        "responses": {
          "202": {
            "description": "Request accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "ID of the snapshot request",
                      "example": "019c5555-6666-7777-8888-999900001111"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["pending"],
                      "description": "Request status",
                      "example": "pending"
                    },
                    "message": {
                      "type": "string",
                      "description": "Status message",
                      "example": "Snapshot request published to oplog"
                    }
                  },
                  "required": ["request_id", "status", "message"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - device not trusted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/brokerage/connections": {
      "get": {
        "operationId": "listBrokerageConnections",
        "tags": ["Sync Brokerage"],
        "summary": "List brokerage connections",
        "description": "Retrieve brokerage connections (authorizations) for the authenticated user or team.\n\n**Scopes**:\n- `me` (default): Returns only your own brokerage connections\n- `team`: Returns all team member connections (team owner only)\n\nEach connection represents an OAuth authorization with a brokerage institution.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": { "type": "string", "enum": ["snaptrade"], "default": "snaptrade" },
            "required": false,
            "name": "provider",
            "in": "query"
          },
          {
            "schema": { "type": "string", "enum": ["me", "team"], "default": "me" },
            "required": false,
            "name": "scope",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "List of brokerage connections",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "provider": {
                      "type": "string",
                      "description": "Provider ID (e.g., snaptrade)"
                    },
                    "is_owner": {
                      "type": "boolean",
                      "description": "True if current user is team owner"
                    },
                    "connections": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "description": "Connection ID (same as authorization_id)"
                          },
                          "authorization_id": {
                            "type": "string",
                            "description": "OAuth authorization ID from provider"
                          },
                          "created_at": {
                            "type": "string",
                            "nullable": true,
                            "description": "Connection creation timestamp"
                          },
                          "updated_at": {
                            "type": "string",
                            "nullable": true,
                            "description": "Last update timestamp"
                          },
                          "disabled": {
                            "type": "boolean",
                            "nullable": true,
                            "description": "Whether connection is disabled"
                          },
                          "status": {
                            "type": "string",
                            "nullable": true,
                            "description": "Connection status (e.g., connected, error)"
                          },
                          "last_synced_at": {
                            "type": "string",
                            "nullable": true,
                            "description": "Last successful sync timestamp"
                          },
                          "user_id": {
                            "type": "string",
                            "nullable": true,
                            "description": "User ID who owns this connection"
                          },
                          "full_name": {
                            "type": "string",
                            "nullable": true,
                            "description": "Full name of connection owner"
                          },
                          "email": {
                            "type": "string",
                            "nullable": true,
                            "description": "Email of connection owner"
                          },
                          "avatar_url": {
                            "type": "string",
                            "nullable": true,
                            "description": "Avatar URL of connection owner"
                          },
                          "is_own_connection": {
                            "type": "boolean",
                            "description": "True if current user owns this connection"
                          },
                          "shared_account_count": {
                            "type": "number",
                            "description": "Number of accounts shared from this connection"
                          },
                          "brokerage": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Brokerage ID from provider"
                              },
                              "name": { "type": "string", "description": "Brokerage name" },
                              "display_name": {
                                "type": "string",
                                "description": "Display name for the brokerage"
                              },
                              "slug": {
                                "type": "string",
                                "description": "Brokerage slug identifier"
                              },
                              "url": { "type": "string", "description": "Brokerage website URL" },
                              "description": {
                                "type": "string",
                                "description": "Brokerage description"
                              },
                              "aws_s3_logo_url": { "type": "string", "description": "Logo URL" },
                              "aws_s3_square_logo_url": {
                                "type": "string",
                                "description": "Square logo URL"
                              },
                              "maintenance_mode": {
                                "type": "boolean",
                                "description": "Is brokerage in maintenance"
                              },
                              "allows_trading": {
                                "type": "boolean",
                                "description": "Supports trading"
                              },
                              "allows_fractional_units": {
                                "type": "boolean",
                                "description": "Supports fractional shares"
                              }
                            },
                            "additionalProperties": { "nullable": true },
                            "description": "Brokerage institution information from provider"
                          },
                          "brokerage_name": {
                            "type": "string",
                            "nullable": true,
                            "description": "Brokerage display name"
                          },
                          "brokerage_slug": {
                            "type": "string",
                            "nullable": true,
                            "description": "Brokerage slug identifier"
                          },
                          "name": {
                            "type": "string",
                            "nullable": true,
                            "description": "Connection name (user-defined or default)"
                          }
                        },
                        "required": [
                          "id",
                          "authorization_id",
                          "created_at",
                          "updated_at",
                          "disabled",
                          "status",
                          "last_synced_at",
                          "user_id",
                          "full_name",
                          "email",
                          "avatar_url",
                          "is_own_connection",
                          "shared_account_count",
                          "brokerage",
                          "brokerage_name",
                          "brokerage_slug",
                          "name"
                        ]
                      },
                      "description": "List of brokerage connections"
                    }
                  },
                  "required": ["provider", "is_owner", "connections"]
                }
              }
            }
          },
          "401": {
            "description": "Authentication required - invalid or missing Bearer token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/brokerage/accounts": {
      "get": {
        "operationId": "listBrokerageAccounts",
        "tags": ["Sync Brokerage"],
        "summary": "List brokerage accounts",
        "description": "List all brokerage accounts accessible to the authenticated user.\n\nThis includes:\n- Your own accounts from connected brokerages\n- Accounts shared with you by household members\n\nEach account includes owner information to distinguish between your accounts and shared accounts.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": { "type": "string" },
            "required": false,
            "name": "connection_id",
            "in": "query"
          },
          {
            "schema": { "type": "string", "enum": ["active", "inactive", "error"] },
            "required": false,
            "name": "status",
            "in": "query"
          },
          {
            "schema": { "type": "integer", "nullable": true, "minimum": 0, "default": 0 },
            "required": false,
            "name": "offset",
            "in": "query"
          },
          {
            "schema": { "type": "integer", "minimum": 1, "maximum": 100, "default": 50 },
            "required": false,
            "name": "limit",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "List of brokerage accounts",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "accounts": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "nullable": true,
                            "description": "Unique identifier for the account"
                          },
                          "brokerage_authorization": {
                            "type": "string",
                            "description": "Connection/authorization ID"
                          },
                          "portfolio_group": {
                            "type": "string",
                            "description": "Portfolio group ID"
                          },
                          "name": {
                            "type": "string",
                            "nullable": true,
                            "description": "Account name (e.g., TFSA, RRSP)"
                          },
                          "number": {
                            "type": "string",
                            "nullable": true,
                            "description": "Account number"
                          },
                          "institution_name": {
                            "type": "string",
                            "description": "Brokerage institution name"
                          },
                          "meta": {
                            "type": "object",
                            "nullable": true,
                            "additionalProperties": { "nullable": true },
                            "description": "Additional provider-specific metadata"
                          },
                          "cash_restrictions": {
                            "type": "array",
                            "items": { "nullable": true },
                            "description": "Cash restrictions"
                          },
                          "created_date": {
                            "type": "string",
                            "description": "Account creation date"
                          },
                          "sync_status": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "holdings": {
                                "type": "object",
                                "properties": {
                                  "last_successful_sync": { "type": "string", "nullable": true },
                                  "initial_sync_completed": { "type": "boolean" }
                                }
                              },
                              "transactions": {
                                "type": "object",
                                "properties": {
                                  "last_successful_sync": { "type": "string", "nullable": true },
                                  "first_transaction_date": { "type": "string", "nullable": true },
                                  "initial_sync_completed": { "type": "boolean" }
                                }
                              }
                            },
                            "description": "Sync status from provider"
                          },
                          "balance": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "total": {
                                "type": "object",
                                "properties": {
                                  "amount": { "type": "number" },
                                  "currency": { "type": "string" }
                                }
                              }
                            },
                            "additionalProperties": { "nullable": true },
                            "description": "Account balance information from provider"
                          },
                          "raw_data": { "nullable": true, "description": "Raw provider data" },
                          "raw_type": {
                            "type": "string",
                            "nullable": true,
                            "description": "Raw account type from provider"
                          },
                          "status": {
                            "type": "string",
                            "nullable": true,
                            "description": "Account status"
                          },
                          "is_paper": {
                            "type": "boolean",
                            "description": "True if paper trading account"
                          },
                          "sync_enabled": {
                            "type": "boolean",
                            "description": "Whether this account is enabled for sync"
                          },
                          "shared_with_household": {
                            "type": "boolean",
                            "description": "Whether this account is shared with household members"
                          },
                          "owner": {
                            "type": "object",
                            "properties": {
                              "user_id": {
                                "type": "string",
                                "format": "uuid",
                                "description": "Unique identifier for the account owner"
                              },
                              "full_name": {
                                "type": "string",
                                "nullable": true,
                                "description": "Full name of the account owner"
                              },
                              "email": {
                                "type": "string",
                                "nullable": true,
                                "description": "Email address of the account owner"
                              },
                              "avatar_url": {
                                "type": "string",
                                "nullable": true,
                                "description": "Avatar URL of the account owner"
                              },
                              "is_own_account": {
                                "type": "boolean",
                                "description": "True if this account belongs to the current user"
                              }
                            },
                            "required": [
                              "user_id",
                              "full_name",
                              "email",
                              "avatar_url",
                              "is_own_account"
                            ],
                            "description": "Account owner information"
                          }
                        },
                        "required": [
                          "id",
                          "name",
                          "number",
                          "sync_enabled",
                          "shared_with_household",
                          "owner"
                        ]
                      },
                      "description": "List of brokerage accounts"
                    },
                    "has_multiple_owners": {
                      "type": "boolean",
                      "description": "True if accounts belong to multiple owners (household)"
                    }
                  },
                  "required": ["accounts", "has_multiple_owners"]
                }
              }
            }
          },
          "401": {
            "description": "Authentication required - invalid or missing Bearer token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/brokerage/accounts/{accountId}/activities": {
      "get": {
        "operationId": "listAccountActivities",
        "tags": ["Sync Brokerage"],
        "summary": "List account activities",
        "description": "Retrieve transaction history for a specific brokerage account.\n\n## API Contract\n\n**Type Fields**:\n- `type`: Canonical type (required) - one of 14 types, computed by mapping layer\n- `raw_type`: Provider type as received (string | null)\n\n**Provenance Fields**:\n- `source_system`: \"SNAPTRADE\" | \"MANUAL\" | \"CSV\" (required)\n- `source_record_id`: Provider's stable identifier (if any)\n- `source_group_id`: Provider's grouping ID for related legs (FX, DRIP, etc.)\n\n**Mapping Metadata** (`mapping_metadata`):\n- `flow.is_external`: For TRANSFER_IN/OUT only - affects net contribution\n- `reasons`: Human-readable mapping explanation\n- `confidence`: 1.0 (high), 0.7 (medium), 0.5 (low)\n\n## 14 Canonical Activity Types\n\n| Type | Purpose | Cash | Qty | Net Contribution |\n|------|---------|------|-----|------------------|\n| `BUY` | Purchase asset | ↓ | ↑ | — |\n| `SELL` | Sell asset | ↑ | ↓ | — |\n| `SPLIT` | Stock split | — | ± | — |\n| `DIVIDEND` | Dividend/distribution income | ↑ | — | — |\n| `INTEREST` | Interest/staking/yield income | ↑ | — | — |\n| `DEPOSIT` | External cash/coin in | ↑ | — | ↑ |\n| `WITHDRAWAL` | External cash/coin out | ↓ | — | ↓ |\n| `TRANSFER_IN` | Move in (internal/external) | ↑ | ↑ | ↑ if external |\n| `TRANSFER_OUT` | Move out (internal/external) | ↓ | ↓ | ↓ if external |\n| `FEE` | Platform/broker fee | ↓ | — | — |\n| `TAX` | Tax payment/withholding | ↓ | — | — |\n| `CREDIT` | Refunds/rebates/bonuses | ↑ | — | — |\n| `ADJUSTMENT` | Header event for multi-leg expansion | ± | ± | — |\n| `UNKNOWN` | Unclassifiable (exclude from calc) | — | — | — |\n\n## External Transfer Flag\n\nFor `TRANSFER_IN` and `TRANSFER_OUT`, check `mapping_metadata.flow.is_external`:\n- **Default**: `false` / undefined (internal by default)\n- **`true`**: External transfer (from/to outside tracked accounts) → affects net contribution\n- Set only when provider explicitly indicates external (EXTERNAL_ASSET_TRANSFER_*) or type represents external assets (STOCK_DIVIDEND)\n\n## Needs Review Flag\n\n`needs_review: true` for ambiguous mappings:\n- Generic `TRANSFER` where external status is unknown\n- Unknown types inferred from amount/units signs\n- Low confidence mappings (`mapping_metadata.confidence < 1.0`)\n\n## Type Mapping Examples (`raw_type` → `type`):\n\n*DEPOSIT (external cash in)*:\n- `CONTRIBUTION`, `ACCOUNT DEPOSIT`, `FUNDING` → `DEPOSIT`\n- `GOV_GRANT`, `RESP_GRANT` → `DEPOSIT`\n\n*WITHDRAWAL (external cash out)*:\n- `WITHDRAWAL`, `ACCOUNT WITHDRAW` → `WITHDRAWAL`\n- `SPEND`, `DEBIT CARD`, `CARDSPEND`, `P2P_PAYMENT` → `WITHDRAWAL`\n\n*INTEREST (all yield, even in-kind)*:\n- `INTEREST`, `CREDIT INTEREST`, `BOND INTEREST` → `INTEREST`\n- `CRYPTO_STAKING_REWARD`, `STAKING_REWARD` → `INTEREST`\n- `INTEREST ADJ` → `INTEREST`\n\n*FEE (expenses, charges)*:\n- `FEE`, `MONTHLY FEE`, `SERVICE FEE`, `ADVISOR FEE` → `FEE`\n- `MARGIN INTEREST` → `FEE` (interest expense, not yield income)\n\n*TRANSFER_IN (internal moves)*:\n- `SWEEP IN`, `JOURNALED SHARES`, `STOCK PLAN` → `TRANSFER_IN`\n- `INTERNAL_CASH_TRANSFER_IN`, `INTERNAL_ASSET_TRANSFER_IN` → `TRANSFER_IN`\n\n*TRANSFER_IN with is_external=true (external assets in)*:\n- `EXTERNAL_ASSET_TRANSFER_IN` → `TRANSFER_IN` + `is_external=true`\n- `STOCK_DIVIDEND` → `TRANSFER_IN` + `is_external=true`\n- `CRYPTO_RECEIVE` → `TRANSFER_IN` + `is_external=true`\n\n*TRANSFER_OUT with is_external=true (external assets out)*:\n- `EXTERNAL_ASSET_TRANSFER_OUT` → `TRANSFER_OUT` + `is_external=true`\n- `CRYPTO_SEND` → `TRANSFER_OUT` + `is_external=true`\n\n*ADJUSTMENT (header events for multi-leg expansion)*:\n- `REI`, `DRI` (reinvestments) → `ADJUSTMENT`\n- `OPTIONEXERCISE`, `OPTIONASSIGNMENT`, `OPTIONEXPIRATION` → `ADJUSTMENT`\n- `CORPORATE_ACTION`, `REORGANIZATION` → `ADJUSTMENT`\n- `FX CONVERSION`, `FUNDS_CONVERSION`, `EXCHANGE` → `ADJUSTMENT`\n- `JOURNAL`, `JOURNALED`, `SWEEP` → `ADJUSTMENT`\n- `LOAN`, `BRW`, `CREDIT_CARD` → `ADJUSTMENT`\n\n*UNKNOWN (unclassifiable)*:\n- `MKT`, `TRANSACTION`, `MISC`, `OTHER` → `UNKNOWN`\n\n## Example Response\n\n```json\n{\n  \"data\": [\n    {\n      \"id\": \"act_123\",\n      \"type\": \"DEPOSIT\",\n      \"subtype\": \"CONTRIBUTION\",\n      \"raw_type\": \"CONTRIBUTION\",\n      \"source_system\": \"SNAPTRADE\",\n      \"source_record_id\": \"abc123-def456\",\n      \"source_group_id\": null,\n      \"mapping_metadata\": {\n        \"flow\": { \"is_external\": true },\n        \"reasons\": [\"CONTRIBUTION treated as external cash deposit\"],\n        \"confidence\": 1.0\n      },\n      \"needs_review\": false,\n      \"amount\": 5000.00,\n      \"currency\": { \"code\": \"CAD\" },\n      \"trade_date\": \"2024-01-15T10:30:00Z\"\n    },\n    {\n      \"id\": \"act_456\",\n      \"type\": \"INTEREST\",\n      \"subtype\": \"STAKING_REWARD\",\n      \"raw_type\": \"CRYPTO_STAKING_REWARD\",\n      \"source_system\": \"SNAPTRADE\",\n      \"source_record_id\": \"xyz789\",\n      \"source_group_id\": null,\n      \"mapping_metadata\": {\n        \"reasons\": [\"CRYPTO_STAKING_REWARD treated as yield income\"],\n        \"confidence\": 1.0\n      },\n      \"needs_review\": false,\n      \"units\": 0.05,\n      \"symbol\": { \"symbol\": \"ETH\" }\n    }\n  ],\n  \"pagination\": { \"offset\": 0, \"limit\": 100, \"has_more\": false }\n}\n```\n\n## Filtering\n\nUse the `types` query parameter with canonical types (e.g., `types=BUY,SELL,DIVIDEND`). The filter is automatically expanded to include corresponding raw types.\n\n## Pagination\n\nResults are paginated. Use `offset` and `limit` parameters to navigate through results.\n\n**Note**: This endpoint supports both your own accounts and accounts shared with you by household members.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "The unique identifier of the brokerage account",
              "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
            },
            "required": true,
            "description": "The unique identifier of the brokerage account",
            "name": "accountId",
            "in": "path"
          },
          {
            "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
            "required": false,
            "name": "start_date",
            "in": "query"
          },
          {
            "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
            "required": false,
            "name": "end_date",
            "in": "query"
          },
          {
            "schema": { "type": "integer", "nullable": true, "minimum": 0, "default": 0 },
            "required": false,
            "name": "offset",
            "in": "query"
          },
          {
            "schema": { "type": "integer", "minimum": 1, "maximum": 1000, "default": 100 },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": { "type": "string", "description": "Comma-separated list of activity types" },
            "required": false,
            "description": "Comma-separated list of activity types",
            "name": "types",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated list of account activities",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "description": "Unique identifier for the transaction"
                          },
                          "account": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the account"
                              },
                              "brokerage_authorization": {
                                "type": "string",
                                "description": "The brokerage authorization (connection) ID this account belongs to"
                              },
                              "name": {
                                "type": "string",
                                "nullable": true,
                                "description": "Account name"
                              },
                              "number": {
                                "type": "string",
                                "nullable": true,
                                "description": "Account number (may be masked)"
                              }
                            },
                            "description": "The account this activity belongs to (includes ID, name, number, and connection ID)"
                          },
                          "symbol": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the symbol"
                              },
                              "symbol": {
                                "type": "string",
                                "description": "Trading ticker symbol (e.g., AAPL, VFV.TO)"
                              },
                              "raw_symbol": {
                                "type": "string",
                                "description": "Symbol without exchange suffix (e.g., VFV for VFV.TO)"
                              },
                              "description": {
                                "type": "string",
                                "nullable": true,
                                "description": "Human-readable security name"
                              },
                              "currency": {
                                "type": "object",
                                "nullable": true,
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "Unique identifier for the currency"
                                  },
                                  "code": {
                                    "type": "string",
                                    "description": "ISO-4217 currency code (e.g., USD, CAD)"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "Human-friendly currency name"
                                  }
                                },
                                "description": "Currency information"
                              },
                              "exchange": {
                                "type": "object",
                                "nullable": true,
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "Unique identifier for the exchange"
                                  },
                                  "code": {
                                    "type": "string",
                                    "description": "Exchange code (e.g., NYSE, TSX, NASDAQ)"
                                  },
                                  "name": { "type": "string", "description": "Exchange name" }
                                },
                                "description": "Stock exchange where the security is traded"
                              },
                              "type": {
                                "type": "object",
                                "nullable": true,
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "Unique identifier for the security type"
                                  },
                                  "code": {
                                    "type": "string",
                                    "description": "Security type code (e.g., cs, et, ef, bond, crypto)"
                                  },
                                  "description": {
                                    "type": "string",
                                    "description": "Human-readable security type (e.g., Common Stock, ETF)"
                                  }
                                },
                                "description": "Security type classification"
                              },
                              "figi_code": {
                                "type": "string",
                                "nullable": true,
                                "description": "Financial Instrument Global Identifier (FIGI)"
                              }
                            },
                            "description": "The security for the transaction (null if not security-related)"
                          },
                          "option_symbol": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the option symbol"
                              },
                              "ticker": {
                                "type": "string",
                                "description": "OCC option symbol (e.g., AAPL 230120C00150000)"
                              },
                              "option_type": {
                                "type": "string",
                                "enum": ["CALL", "PUT"],
                                "description": "Option type: CALL (right to buy) or PUT (right to sell)"
                              },
                              "strike_price": {
                                "type": "number",
                                "description": "Strike price of the option contract"
                              },
                              "expiration_date": {
                                "type": "string",
                                "description": "Option expiration date in ISO format (YYYY-MM-DD)"
                              },
                              "is_mini_option": {
                                "type": "boolean",
                                "description": "True if this is a mini option (10 shares per contract instead of 100)"
                              },
                              "underlying_symbol": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "Unique identifier for the underlying"
                                  },
                                  "symbol": {
                                    "type": "string",
                                    "description": "Ticker symbol of the underlying"
                                  },
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "description": "Name of the underlying security"
                                  },
                                  "currency": {
                                    "type": "object",
                                    "nullable": true,
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Unique identifier for the currency"
                                      },
                                      "code": {
                                        "type": "string",
                                        "description": "ISO-4217 currency code (e.g., USD, CAD)"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Human-friendly currency name"
                                      }
                                    },
                                    "description": "Currency information"
                                  }
                                },
                                "description": "The underlying security for this option contract"
                              }
                            },
                            "required": [
                              "id",
                              "ticker",
                              "option_type",
                              "strike_price",
                              "expiration_date"
                            ],
                            "description": "The option security for the transaction (null if not option-related)"
                          },
                          "price": {
                            "type": "number",
                            "description": "Price per unit (applicable to BUY, SELL, DIVIDEND)"
                          },
                          "units": {
                            "type": "number",
                            "description": "Number of units (applicable to BUY, SELL, DIVIDEND)"
                          },
                          "amount": {
                            "type": "number",
                            "nullable": true,
                            "description": "Transaction amount in currency (always positive after normalization)"
                          },
                          "currency": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the currency"
                              },
                              "code": {
                                "type": "string",
                                "description": "ISO-4217 currency code (e.g., USD, CAD)"
                              },
                              "name": {
                                "type": "string",
                                "description": "Human-friendly currency name"
                              }
                            },
                            "description": "Currency for price and amount"
                          },
                          "fee": {
                            "type": "number",
                            "description": "Fee associated with transaction (always positive after normalization)"
                          },
                          "fx_rate": {
                            "type": "number",
                            "nullable": true,
                            "description": "Forex conversion rate (for cross-currency transactions)"
                          },
                          "type": {
                            "type": "string",
                            "description": "Canonical transaction type (required). One of: BUY, SELL, SPLIT, DIVIDEND, INTEREST, DEPOSIT, WITHDRAWAL, TRANSFER_IN, TRANSFER_OUT, FEE, TAX, CREDIT, ADJUSTMENT, UNKNOWN. For TRANSFER_IN/OUT, check mapping_metadata.flow.is_external to determine if it affects net contributions.",
                            "example": "DEPOSIT"
                          },
                          "subtype": {
                            "type": "string",
                            "description": "More specific categorization of the transaction type. Examples: DRIP (dividend reinvestment), STAKING_REWARD (crypto staking), RETURN_OF_CAPITAL, QUALIFIED_DIVIDEND, CAPITAL_GAIN, etc. Defaults to raw_type if no specific mapping exists.",
                            "example": "CONTRIBUTION"
                          },
                          "raw_type": {
                            "type": "string",
                            "nullable": true,
                            "description": "Original transaction type from the brokerage provider as received. Null if provider didn't send one.",
                            "example": "CONTRIBUTION"
                          },
                          "source_system": {
                            "type": "string",
                            "enum": ["SNAPTRADE", "MANUAL", "CSV"],
                            "description": "Source system that provided this activity",
                            "example": "SNAPTRADE"
                          },
                          "source_record_id": {
                            "type": "string",
                            "nullable": true,
                            "description": "Provider's stable identifier for this record (if any)",
                            "example": "abc123-def456"
                          },
                          "source_group_id": {
                            "type": "string",
                            "nullable": true,
                            "description": "Provider's identifier for grouping related legs (e.g., FX pairs, DRIP, transfers)",
                            "example": "abc123-def456"
                          },
                          "mapping_metadata": {
                            "type": "object",
                            "properties": {
                              "flow": {
                                "type": "object",
                                "properties": {
                                  "is_external": {
                                    "type": "boolean",
                                    "description": "True if the transfer is from/to an external source (affects net contribution calculations). Only applicable to TRANSFER_IN and TRANSFER_OUT types. Default is false (internal)."
                                  }
                                },
                                "description": "Flow information for transfer types"
                              },
                              "reasons": {
                                "type": "array",
                                "items": { "type": "string" },
                                "description": "Human-readable reasons explaining the mapping decision",
                                "example": ["CONTRIBUTION treated as external cash deposit"]
                              },
                              "confidence": {
                                "type": "number",
                                "description": "Confidence score: 1.0 = high (direct match), 0.7 = medium (inferred direction), 0.5 = low (fallback inference)",
                                "example": 1
                              }
                            },
                            "description": "Metadata explaining how/why the mapping was made. Does NOT include the canonical type."
                          },
                          "needs_review": {
                            "type": "boolean",
                            "description": "True if the mapping is ambiguous and needs user review. Set for generic transfers (external status unknown), unknown types inferred from amount/units signs, or low confidence mappings.",
                            "example": false
                          },
                          "option_type": {
                            "type": "string",
                            "description": "For option BUY/SELL: BUY_TO_OPEN, BUY_TO_CLOSE, SELL_TO_OPEN, or SELL_TO_CLOSE"
                          },
                          "description": {
                            "type": "string",
                            "description": "Human-readable description from brokerage"
                          },
                          "trade_date": {
                            "type": "string",
                            "nullable": true,
                            "description": "Transaction date/time (granularity varies by brokerage)"
                          },
                          "settlement_date": { "type": "string", "description": "Settlement date" },
                          "institution": { "type": "string", "description": "Brokerage name" },
                          "external_reference_id": {
                            "type": "string",
                            "nullable": true,
                            "description": "Brokerage reference ID to group related transactions"
                          }
                        },
                        "required": [
                          "type",
                          "subtype",
                          "raw_type",
                          "source_system",
                          "source_record_id",
                          "source_group_id",
                          "needs_review"
                        ]
                      },
                      "description": "List of activities"
                    },
                    "pagination": {
                      "type": "object",
                      "properties": {
                        "offset": {
                          "type": "number",
                          "description": "Current offset in the result set"
                        },
                        "limit": {
                          "type": "number",
                          "description": "Maximum number of results per page"
                        },
                        "total": {
                          "type": "number",
                          "description": "Total number of results available"
                        },
                        "has_more": {
                          "type": "boolean",
                          "description": "Whether more results are available"
                        }
                      },
                      "required": ["offset", "limit"],
                      "description": "Pagination information"
                    }
                  },
                  "required": ["data", "pagination"]
                }
              }
            }
          },
          "401": {
            "description": "Authentication required - invalid or missing Bearer token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Account not found or you do not have access to this account",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/sync/brokerage/accounts/{accountId}/holdings": {
      "get": {
        "operationId": "getAccountHoldings",
        "tags": ["Sync Brokerage"],
        "summary": "Get account holdings",
        "description": "Retrieve holdings for a specific brokerage account.\n\nReturns:\n- **Cash balances**: Available cash and buying power by currency\n- **Positions**: Stock, ETF, and mutual fund holdings with current prices and unrealized P&L\n- **Option positions**: Options contracts with strike prices and expiration dates\n\n**Note**: This endpoint supports both your own accounts and accounts shared with you by household members.",
        "security": [{ "bearer": [] }],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid",
              "description": "The unique identifier of the brokerage account",
              "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
            },
            "required": true,
            "description": "The unique identifier of the brokerage account",
            "name": "accountId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Account holdings retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "account": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "id": { "type": "string" },
                        "name": { "type": "string", "nullable": true },
                        "number": { "type": "string", "nullable": true },
                        "raw_type": { "type": "string", "nullable": true }
                      },
                      "additionalProperties": { "nullable": true },
                      "description": "Account information"
                    },
                    "balances": {
                      "type": "array",
                      "nullable": true,
                      "items": {
                        "type": "object",
                        "properties": {
                          "currency": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the currency"
                              },
                              "code": { "type": "string", "description": "ISO-4217 currency code" },
                              "name": {
                                "type": "string",
                                "description": "Human-friendly currency name"
                              }
                            },
                            "description": "Currency for the balance"
                          },
                          "cash": {
                            "type": "number",
                            "nullable": true,
                            "description": "Available cash balance"
                          },
                          "buying_power": {
                            "type": "number",
                            "nullable": true,
                            "description": "Buying power (for margin accounts)"
                          }
                        }
                      },
                      "description": "Cash balances by currency"
                    },
                    "positions": {
                      "type": "array",
                      "nullable": true,
                      "items": {
                        "type": "object",
                        "properties": {
                          "symbol": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "symbol": {
                                "type": "object",
                                "properties": {
                                  "id": { "type": "string" },
                                  "symbol": {
                                    "type": "string",
                                    "description": "Trading ticker symbol"
                                  },
                                  "raw_symbol": {
                                    "type": "string",
                                    "description": "Symbol without exchange suffix"
                                  },
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "description": "Security name"
                                  },
                                  "name": {
                                    "type": "string",
                                    "nullable": true,
                                    "description": "Full security name"
                                  },
                                  "currency": {
                                    "type": "object",
                                    "nullable": true,
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Unique identifier for the currency"
                                      },
                                      "code": {
                                        "type": "string",
                                        "description": "ISO-4217 currency code"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Human-friendly currency name"
                                      }
                                    }
                                  },
                                  "type": {
                                    "type": "object",
                                    "nullable": true,
                                    "properties": {
                                      "id": { "type": "string" },
                                      "code": { "type": "string" },
                                      "description": { "type": "string" }
                                    }
                                  }
                                }
                              },
                              "id": { "type": "string" },
                              "description": { "type": "string" }
                            },
                            "description": "Security information"
                          },
                          "units": {
                            "type": "number",
                            "nullable": true,
                            "description": "Number of shares held"
                          },
                          "price": {
                            "type": "number",
                            "nullable": true,
                            "description": "Current market price per share"
                          },
                          "open_pnl": {
                            "type": "number",
                            "nullable": true,
                            "description": "Unrealized profit/loss on the position"
                          },
                          "average_purchase_price": {
                            "type": "number",
                            "nullable": true,
                            "description": "Average cost basis per share"
                          },
                          "currency": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the currency"
                              },
                              "code": { "type": "string", "description": "ISO-4217 currency code" },
                              "name": {
                                "type": "string",
                                "description": "Human-friendly currency name"
                              }
                            },
                            "description": "Currency for price and values"
                          },
                          "cash_equivalent": {
                            "type": "boolean",
                            "nullable": true,
                            "description": "If position is a cash equivalent (money market fund)"
                          }
                        }
                      },
                      "description": "Stock/ETF/mutual fund positions"
                    },
                    "option_positions": {
                      "type": "array",
                      "nullable": true,
                      "items": {
                        "type": "object",
                        "properties": {
                          "symbol": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the option"
                              },
                              "ticker": { "type": "string", "description": "OCC option symbol" },
                              "option_type": {
                                "type": "string",
                                "enum": ["CALL", "PUT"],
                                "description": "Option type"
                              },
                              "strike_price": { "type": "number", "description": "Strike price" },
                              "expiration_date": {
                                "type": "string",
                                "description": "Expiration date (ISO format)"
                              },
                              "is_mini_option": { "type": "boolean" },
                              "underlying_symbol": {
                                "type": "object",
                                "properties": {
                                  "id": { "type": "string" },
                                  "symbol": { "type": "string" },
                                  "description": { "type": "string", "nullable": true }
                                }
                              }
                            },
                            "required": [
                              "id",
                              "ticker",
                              "option_type",
                              "strike_price",
                              "expiration_date"
                            ]
                          },
                          "units": {
                            "type": "number",
                            "nullable": true,
                            "description": "Number of contracts"
                          },
                          "price": {
                            "type": "number",
                            "nullable": true,
                            "description": "Current price per contract"
                          },
                          "average_purchase_price": { "type": "number", "nullable": true },
                          "currency": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique identifier for the currency"
                              },
                              "code": { "type": "string", "description": "ISO-4217 currency code" },
                              "name": {
                                "type": "string",
                                "description": "Human-friendly currency name"
                              }
                            }
                          }
                        }
                      },
                      "description": "Option positions"
                    }
                  }
                },
                "example": {
                  "account": {
                    "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                    "name": "TFSA",
                    "number": "****1234",
                    "type": "TFSA"
                  },
                  "balances": [
                    {
                      "currency": { "code": "CAD", "name": "Canadian Dollar" },
                      "cash": 5432.1,
                      "buying_power": 5432.1
                    }
                  ],
                  "positions": [
                    {
                      "symbol": {
                        "symbol": {
                          "symbol": "VFV.TO",
                          "raw_symbol": "VFV",
                          "description": "Vanguard S&P 500 Index ETF"
                        }
                      },
                      "units": 50,
                      "price": 120.5,
                      "average_purchase_price": 105.25,
                      "open_pnl": 762.5,
                      "currency": { "code": "CAD" },
                      "cash_equivalent": false
                    }
                  ],
                  "option_positions": []
                }
              }
            }
          },
          "401": {
            "description": "Authentication required - invalid or missing Bearer token",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          },
          "404": {
            "description": "Account not found or you do not have access to this account",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error code (e.g., UNAUTHORIZED, FORBIDDEN, NOT_FOUND)",
                      "example": "UNAUTHORIZED"
                    },
                    "code": {
                      "type": "string",
                      "description": "Error code (same as error field)",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "description": "Human-readable error message",
                      "example": "Authentication required"
                    }
                  },
                  "required": ["error", "code", "message"]
                }
              }
            }
          }
        }
      }
    }
  }
}
